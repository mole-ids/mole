language: go
os: linux

git:
  depth: false

services:
  - docker

env:
  global:
    - STRUCTOR_VERSION=v1.10.0

install:
  - apt-get -qq update
  - apt-get -y install build-essential autoconf libtool bison flex make
  - ./script/install_pfring.sh
  - ./script/install_yara.sh

before_script:
  - go mod download

script:
  - make test

before_deploy:
  - >
    if [ x$TRAVIS_TAG != x"" ]; then
      echo "Building binaries";
      make build_all
      cd build
      for f in $(ls *); do
        sha256sum $f >> "mole_$TRAVIS_TAG_sha256_checksums.txt"
      done
      cd -
    fi

    echo "Download documentation generator";
    curl -sfL https://raw.githubusercontent.com/containous/structor/master/godownloader.sh | bash -s -- -b $GOPATH/bin ${STRUCTOR_VERSION}
    
    echo "Build documentation";
    "$GOPATH/bin/structor" -o jpalanco -r mole \
            --force-edit-url \
            --dockerfile-url="https://raw.githubusercontent.com/mole-ids/mole/master/docs/docs.Dockerfile" \
            --menu.js-url="https://raw.githubusercontent.com/mole-ids/mole/master/docs/theme/structor-menu.js.gotmpl" \
            --exp-branch=master --debug;
          chown -R $UID site;

deploy:
  - provider: releases
    api_key: ${GITHUB_TOKEN}
    file: build/mole*
    file_glob: true
    on:
      repo: mole-ids/mole
      tags: true

  - provider: pages
    edge: false
    github_token: ${GITHUB_TOKEN}
    local_dir: site
    on:
      repo: mole-ids/mole
      all_branches: true
